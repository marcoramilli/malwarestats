self.importScripts("/assets/lib/underscore/underscore-min.js");


function finTheRightKey(obj){
  // I am assuming two keys: X and result.
 var k = _.keys(obj); 
 return _.difference(k,["result"])[0];
}


function buildOutput (data_out, obj){
  //{
  // "x" : "pippo",
  // "result" : 324 
  //}
  //

  var x = finTheRightKey(obj); //Packer
  var value_to_be_found = obj[x]; //pippo

  if (0 === data_out.length){
    data_out.push(obj); 
  }
  else{ 
    for( i=0; i<data_out.length; i++){
      if (value_to_be_found === data_out[i][x]){
        data_out[i].result = data_out[i].result + obj.result;
        break;;
      }else {
        if (i === data_out.length -1){
          var new_obj = new Object();
          new_obj[x] = value_to_be_found;
          new_obj['result'] = obj.result;
          data_out.push(new_obj);
        }
      }
    }
  }
};


onmessage = function(e){
  //Please Add controlts Here !!!!!
  var err         = e.data[0];
  var data        = e.data[1];
  var filter      = e.data[2];
  var data_out = new Array();

  if (err){
  } 
  else {


    if (undefined !== data){
      for (var j=0; j<data.length; j++){
        var t =  _.isArray( data[j][filter] );
        if (!t){
            if (undefined !== data[filter] && undefined !== data[filter].result)
              buildOutput(data);  
        }
        else{
          for(var k=0; k<data[j][filter].length; k++){
            if (undefined !== data[j][filter][k] && undefined !== data[j].result){ 
              var obj = new Object(); //I want make it esplicit
              obj[filter] = data[j][filter][k];
              obj['result'] = data[j].result;
              buildOutput(data_out,  obj );
            }
          }
        }  
      }
      postMessage(data_out);
    }
  }

}//mainfunction




